<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="专注于移动互联网行业，不断进行自我提升"><meta name="baidu-site-verification" content="code-Gk4XZmB8KD"><meta name="keywords" content="Flow,kotlin"><title>异步流的方法详解 | BlueSky's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + '5bd48e5641556bcc5d9e090dd3bb9fbc';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><script>(function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/225e0df7.js","daovoice")</script><meta name="generator" content="Hexo 4.2.1"></head><script>window.paceOptions = {ajax: false,eventLag: false,elements: false}</script><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet"><style>.pace .pace-progress {
background: #1abc9c;
height: 3px;
}
.pace .pace-progress-inner {
box-shadow: 0 0 10px #1abc9c, 0 0 5px     #1abc9c;
}
.pace .pace-activity {
border-top-color: #1abc9c; 
border-left-color: #1abc9c; 
}</style><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">异步流的方法详解</h1><a id="logo" href="/.">BlueSky's Blog</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/categories/"><i class="fa fa fa-th"> 分类</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="header-sidebar-menu header-sidebar-menu-black">&raquo;</div><script type="text/javascript" src="/js/sidebar_left.js?v=0.0.0" async></script><div class="sidebar ps"><ul class="sidebar-tabs"><li class="sidebar-tab-archives sidebar-tab"><span class="fa fa-archive"></span><span class="sidebar-tab-name">Archive</span></li>        <li class="sidebar-tab-tags sidebar-tab"><span class="fa fa-tag"></span><span class="sidebar-tab-name">Tag</span></li>        <li class="sidebar-tab-categories sidebar-tab"><span class="fa fa-folder-o"></span><span class="sidebar-tab-name">Cate</span></li></ul><div class="sidebar-contents"><div class="sidebar-content-archives sidebar-content"><!--Use lodash to classify posts. See https://lodash.com/docs#groupBy--><h4>2020</h4><ul class="sidebar-listing"><li><a class="sidebar-archives-a" href="/article/ad6c93b9/" title="bat命令">07/12 bat命令</a></li><li><a class="sidebar-archives-a" href="/article/35fb243/" title="优美的句子">07/19 优美的句子</a></li><li><a class="sidebar-archives-a" href="/article/1a8f4df9/" title="JAVA并发编程-原子性、可见性、有序性">07/25 JAVA并发编程-原子性、可见性、有序性</a></li><li><a class="sidebar-archives-a" href="/article/856a5aa8/" title="abbrlink踩坑">11/21 abbrlink踩坑</a></li><li><a class="sidebar-archives-a" href="/article/497b1455/" title="JAVA数据结构之Map集合">07/21 JAVA数据结构之Map集合</a></li><li><a class="sidebar-archives-a" href="/article/a0d5c7de/" title="算法稳定性介绍">09/15 算法稳定性介绍</a></li><li><a class="sidebar-archives-a" href="/article/b2b6f046/" title="几个经典的动态规划问题">09/26 几个经典的动态规划问题</a></li><li><a class="sidebar-archives-a" href="/article/e6c2b842/" title="生产者与消费者模式">11/06 生产者与消费者模式</a></li><li><a class="sidebar-archives-a" href="/article/71c610d3/" title="单链表">09/05 单链表</a></li><li><a class="sidebar-archives-a" href="/article/fa8ccf2d/" title="JavaPoet讲解">09/13 JavaPoet讲解</a></li><li><a class="sidebar-archives-a" href="/article/a6b81681/" title="线程模型&amp;线程池">10/20 线程模型&amp;线程池</a></li><li><a class="sidebar-archives-a" href="/article/762aaa36/" title="异步流使用详解">12/15 异步流使用详解</a></li><li><a class="sidebar-archives-a" href="/article/2905e442/" title="Android中协程的特点">10/09 Android中协程的特点</a></li><li><a class="sidebar-archives-a" href="/article/5a190551/" title="JAVA并发编程-阻塞队列之ArrayBlockingQueue详解">08/01 JAVA并发编程-阻塞队列之ArrayBlockingQueue详解</a></li><li><a class="sidebar-archives-a" href="/article/c47eb885/" title="协程详解">11/14 协程详解</a></li><li><a class="sidebar-archives-a" href="/article/8b3b35/" title="Zygote详解">08/07 Zygote详解</a></li><li><a class="sidebar-archives-a" href="/article/7cab1e06/" title="二叉搜索树">12/22 二叉搜索树</a></li><li><a class="sidebar-archives-a" href="/article/dda7bba2/" title="gradle命令">08/15 gradle命令</a></li><li><a class="sidebar-archives-a" href="/article/335c74d5/" title="线程池原理">12/05 线程池原理</a></li></ul><h4>2021</h4><ul class="sidebar-listing"><li><a class="sidebar-archives-a" href="/article/b0029a08/" title="java并发编程-ThreadLocal">01/12 java并发编程-ThreadLocal</a></li><li><a class="sidebar-archives-a" href="/article/76ae8ac8/" title="异步流的方法详解">02/17 异步流的方法详解</a></li><li><a class="sidebar-archives-a" href="/article/22df6896/" title="并发工具类的使用">02/09 并发工具类的使用</a></li><li><a class="sidebar-archives-a" href="/article/603b68b6/" title="DecorView介绍">01/26 DecorView介绍</a></li><li><a class="sidebar-archives-a" href="/article/bb06284f/" title="二叉树基础操作">04/02 二叉树基础操作</a></li><li><a class="sidebar-archives-a" href="/article/1062d183/" title="二叉树非递归遍历">03/12 二叉树非递归遍历</a></li><li><a class="sidebar-archives-a" href="/article/cec99305/" title="okhttp框架分析">01/15 okhttp框架分析</a></li><li><a class="sidebar-archives-a" href="/article/88d274c3/" title="碎片">09/25 碎片</a></li><li><a class="sidebar-archives-a" href="/article/8e10e406/" title="gradle执行流程">06/23 gradle执行流程</a></li><li><a class="sidebar-archives-a" href="/article/435ae83e/" title="groovy 学习">07/10 groovy 学习</a></li><li><a class="sidebar-archives-a" href="/article/dcc2a71f/" title="对象深度拷贝">05/22 对象深度拷贝</a></li><li><a class="sidebar-archives-a" href="/article/4e400033/" title="arr打包">06/17 arr打包</a></li><li><a class="sidebar-archives-a" href="/article/32d3c5f7/" title="插件kotlin化">08/13 插件kotlin化</a></li><li><a class="sidebar-archives-a" href="/article/8d839750/" title="代码混淆配置">06/05 代码混淆配置</a></li><li><a class="sidebar-archives-a" href="/article/cad98d1c/" title="字节码插桩">09/12 字节码插桩</a></li><li><a class="sidebar-archives-a" href="/article/a2759747/" title="自定义插件">08/12 自定义插件</a></li></ul></div><div class="sidebar-content-tags sidebar-content"><a class="sidebar-archives-a sidebar-tag-item" href="/tags/bat%E5%91%BD%E4%BB%A4/"><i class="fa fa-tag"></i>bat命令</a><a class="sidebar-archives-a sidebar-tag-item" href="/tags/java/"><i class="fa fa-tag"></i>java</a><a class="sidebar-archives-a sidebar-tag-item" href="/tags/abbrlink/"><i class="fa fa-tag"></i>abbrlink</a><a class="sidebar-archives-a sidebar-tag-item" href="/tags/%E7%A8%B3%E5%AE%9A%E6%80%A7/"><i class="fa fa-tag"></i>稳定性</a><a class="sidebar-archives-a sidebar-tag-item" href="/tags/%E5%BF%AB%E6%8E%92/"><i class="fa fa-tag"></i>快排</a><a class="sidebar-archives-a sidebar-tag-item" href="/tags/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/"><i class="fa fa-tag"></i>动态规划</a><a class="sidebar-archives-a sidebar-tag-item" href="/tags/%E7%94%9F%E4%BA%A7%E8%80%85%E4%B8%8E%E6%B6%88%E8%B4%B9%E8%80%85/"><i class="fa fa-tag"></i>生产者与消费者</a><a class="sidebar-archives-a sidebar-tag-item" href="/tags/%E5%8D%95%E9%93%BE%E8%A1%A8/"><i class="fa fa-tag"></i>单链表</a><a class="sidebar-archives-a sidebar-tag-item" href="/tags/ThreadLocal/"><i class="fa fa-tag"></i>ThreadLocal</a><a class="sidebar-archives-a sidebar-tag-item" href="/tags/JavaPoet/"><i class="fa fa-tag"></i>JavaPoet</a><a class="sidebar-archives-a sidebar-tag-item" href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/"><i class="fa fa-tag"></i>线程池</a><a class="sidebar-archives-a sidebar-tag-item" href="/tags/%E5%BC%82%E6%AD%A5%E6%B5%81/"><i class="fa fa-tag"></i>异步流</a><a class="sidebar-archives-a sidebar-tag-item" href="/tags/%E5%8D%8F%E7%A8%8B/"><i class="fa fa-tag"></i>协程</a><a class="sidebar-archives-a sidebar-tag-item" href="/tags/Flow/"><i class="fa fa-tag"></i>Flow</a><a class="sidebar-archives-a sidebar-tag-item" href="/tags/CountDownLatch/"><i class="fa fa-tag"></i>CountDownLatch</a><a class="sidebar-archives-a sidebar-tag-item" href="/tags/CyclicBarrier/"><i class="fa fa-tag"></i>CyclicBarrier</a><a class="sidebar-archives-a sidebar-tag-item" href="/tags/Semaphore/"><i class="fa fa-tag"></i>Semaphore</a><a class="sidebar-archives-a sidebar-tag-item" href="/tags/Exchanger/"><i class="fa fa-tag"></i>Exchanger</a><a class="sidebar-archives-a sidebar-tag-item" href="/tags/Zygote/"><i class="fa fa-tag"></i>Zygote</a><a class="sidebar-archives-a sidebar-tag-item" href="/tags/DecorView/"><i class="fa fa-tag"></i>DecorView</a><a class="sidebar-archives-a sidebar-tag-item" href="/tags/%E4%BA%8C%E5%8F%89%E6%90%9C%E7%B4%A2%E6%A0%91/"><i class="fa fa-tag"></i>二叉搜索树</a><a class="sidebar-archives-a sidebar-tag-item" href="/tags/%E4%BA%8C%E5%8F%89%E6%A0%91/"><i class="fa fa-tag"></i>二叉树</a><a class="sidebar-archives-a sidebar-tag-item" href="/tags/gradle/"><i class="fa fa-tag"></i>gradle</a><a class="sidebar-archives-a sidebar-tag-item" href="/tags/okhttp/"><i class="fa fa-tag"></i>okhttp</a><a class="sidebar-archives-a sidebar-tag-item" href="/tags/groovy/"><i class="fa fa-tag"></i>groovy</a><a class="sidebar-archives-a sidebar-tag-item" href="/tags/%E5%AF%B9%E8%B1%A1%E6%8B%B7%E8%B4%9D/"><i class="fa fa-tag"></i>对象拷贝</a><a class="sidebar-archives-a sidebar-tag-item" href="/tags/arr%E6%89%93%E5%8C%85/"><i class="fa fa-tag"></i>arr打包</a><a class="sidebar-archives-a sidebar-tag-item" href="/tags/%E6%8F%92%E4%BB%B6kotlin%E5%8C%96/"><i class="fa fa-tag"></i>插件kotlin化</a><a class="sidebar-archives-a sidebar-tag-item" href="/tags/%E4%BB%A3%E7%A0%81%E6%B7%B7%E6%B7%86/"><i class="fa fa-tag"></i>代码混淆</a><a class="sidebar-archives-a sidebar-tag-item" href="/tags/ASM%E6%8F%92%E6%A1%A9/"><i class="fa fa-tag"></i>ASM插桩</a><a class="sidebar-archives-a sidebar-tag-item" href="/tags/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8F%92%E4%BB%B6/"><i class="fa fa-tag"></i>自定义插件</a></div><div class="sidebar-content-categories sidebar-content"><a class="sidebar-archives-a sidebar-tag-item" href="/categories/%E6%8A%80%E5%B7%A7/"><i class="fa fa-folder-o"></i>技巧</a><a class="sidebar-archives-a sidebar-tag-item" href="/categories/%E7%AE%97%E6%B3%95/"><i class="fa fa-folder-o"></i>算法</a><a class="sidebar-archives-a sidebar-tag-item" href="/categories/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"><i class="fa fa-folder-o"></i>并发编程</a><a class="sidebar-archives-a sidebar-tag-item" href="/categories/%E8%B8%A9%E5%9D%91%E6%97%A5%E8%AE%B0/"><i class="fa fa-folder-o"></i>踩坑日记</a><a class="sidebar-archives-a sidebar-tag-item" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"><i class="fa fa-folder-o"></i>数据结构</a><a class="sidebar-archives-a sidebar-tag-item" href="/categories/%E6%A1%86%E6%9E%B6/"><i class="fa fa-folder-o"></i>框架</a><a class="sidebar-archives-a sidebar-tag-item" href="/categories/kotlin/"><i class="fa fa-folder-o"></i>kotlin</a><a class="sidebar-archives-a sidebar-tag-item" href="/categories/Android/"><i class="fa fa-folder-o"></i>Android</a><a class="sidebar-archives-a sidebar-tag-item" href="/categories/java/"><i class="fa fa-folder-o"></i>java</a></div></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">异步流的方法详解</h1><div class="post-meta">2021-02-17<span> | </span><span class="category"><a href="/categories/kotlin/">kotlin</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 1.4k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 6</span><span class="post-meta-item-text"> 分钟</span></span></span></div><!--if page.toc--><!--  div(class='clear')--><!--    div(id='toc' class='toc-article')--><!--      div(class='toc-title')= __('contents')--><!--      != toc(page.content, {list_number: theme.toc_number})--><div class="post-content"><p>[TOC]</p>
<h2 id="flowOn-操作符"><a href="#flowOn-操作符" class="headerlink" title="flowOn 操作符"></a>flowOn 操作符</h2><p>该函数用于更改流发射的上下文。</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">simple</span><span class="params">()</span></span>: Flow&lt;<span class="built_in">Int</span>&gt; = flow &#123;</span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1</span>..<span class="number">3</span>) &#123;</span><br><span class="line">        Thread.sleep(<span class="number">100</span>) <span class="comment">// 假装我们以消耗 CPU 的方式进行计算</span></span><br><span class="line">        log(<span class="string">"Emitting <span class="variable">$i</span>"</span>)</span><br><span class="line">        emit(i) <span class="comment">// 发射下一个值</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;.flowOn(Dispatchers.Default) <span class="comment">// 在流构建器中改变消耗 CPU 代码上下文的正确方式</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    simple().collect &#123; value -&gt;</span><br><span class="line">        log(<span class="string">"Collected <span class="variable">$value</span>"</span>) </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">[DefaultDispatcher-worker<span class="number">-1</span> @coroutine#<span class="number">2</span>] Emitting <span class="number">1</span></span><br><span class="line">[main @coroutine#<span class="number">1</span>] Collected <span class="number">1</span></span><br><span class="line">[DefaultDispatcher-worker<span class="number">-1</span> @coroutine#<span class="number">2</span>] Emitting <span class="number">2</span></span><br><span class="line">[main @coroutine#<span class="number">1</span>] Collected <span class="number">2</span></span><br><span class="line">[DefaultDispatcher-worker<span class="number">-1</span> @coroutine#<span class="number">2</span>] Emitting <span class="number">3</span></span><br><span class="line">[main @coroutine#<span class="number">1</span>] Collected <span class="number">3</span></span><br></pre></td></tr></table></figure>

<p> flowOn 操作符已改变流的默认顺序性。 现在收集发生在一个协程中（“coroutine#1”）而发射发生在运行于另一个线程中与收集协程并发运行的另一个协程（“coroutine#2”）中。当上游流必须改变其上下文中的 CoroutineDispatcher 的时候，flowOn 操作符创建了另一个协程。</p>
<h2 id="缓冲"><a href="#缓冲" class="headerlink" title="缓冲"></a>缓冲</h2><figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">simple</span><span class="params">()</span></span>: Flow&lt;<span class="built_in">Int</span>&gt; = flow &#123;</span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1</span>..<span class="number">3</span>) &#123;</span><br><span class="line">        delay(<span class="number">100</span>) <span class="comment">// 假装我们异步等待了 100 毫秒</span></span><br><span class="line">        emit(i) <span class="comment">// 发射下一个值</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123; </span><br><span class="line">    <span class="keyword">val</span> time = measureTimeMillis &#123;</span><br><span class="line">        simple()</span><br><span class="line">            .buffer() <span class="comment">// 缓冲发射项，无需等待</span></span><br><span class="line">            .collect &#123; value -&gt; </span><br><span class="line">                delay(<span class="number">300</span>) <span class="comment">// 假装我们花费 300 毫秒来处理它</span></span><br><span class="line">                println(value) </span><br><span class="line">            &#125; </span><br><span class="line">    &#125;   </span><br><span class="line">    println(<span class="string">"Collected in <span class="variable">$time</span> ms"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line">Collected <span class="keyword">in</span> <span class="number">1054</span> ms</span><br></pre></td></tr></table></figure>

<p>注意，当必须更改 CoroutineDispatcher 时，flowOn 操作符使用了相同的缓冲机制， 但是我们在这里显式地请求缓冲而不改变执行上下文。</p>
<h2 id="合并"><a href="#合并" class="headerlink" title="合并"></a>合并</h2><p>当流代表部分操作结果或操作状态更新时，可能没有必要处理每个值，而是只处理最新的那个。</p>
<p>当收集器处理它们太慢的时候， conflate 操作符可以用于跳过中间值。</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> time = measureTimeMillis &#123;</span><br><span class="line">    simple()</span><br><span class="line">        .conflate() <span class="comment">// 合并发射项，不对每个值进行处理</span></span><br><span class="line">        .collect &#123; value -&gt; </span><br><span class="line">            delay(<span class="number">300</span>) <span class="comment">// 假装我们花费 300 毫秒来处理它</span></span><br><span class="line">            println(value) </span><br><span class="line">        &#125; </span><br><span class="line">&#125;   </span><br><span class="line">println(<span class="string">"Collected in <span class="variable">$time</span> ms"</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line">Collected <span class="keyword">in</span> <span class="number">749</span> ms</span><br></pre></td></tr></table></figure>



<h2 id="处理最新值"><a href="#处理最新值" class="headerlink" title="处理最新值"></a>处理最新值</h2><figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> time = measureTimeMillis &#123;</span><br><span class="line">    simple()</span><br><span class="line">        .collectLatest &#123; value -&gt; <span class="comment">// 取消并重新发射最后一个值</span></span><br><span class="line">            println(<span class="string">"Collecting <span class="variable">$value</span>"</span>) </span><br><span class="line">            delay(<span class="number">300</span>) <span class="comment">// 假装我们花费 300 毫秒来处理它</span></span><br><span class="line">            println(<span class="string">"Done <span class="variable">$value</span>"</span>) </span><br><span class="line">        &#125; </span><br><span class="line">&#125;   </span><br><span class="line">println(<span class="string">"Collected in <span class="variable">$time</span> ms"</span>)</span><br></pre></td></tr></table></figure>

<p>由于 collectLatest 的函数体需要花费 300 毫秒，但是新值每 100 秒发射一次，我们看到该代码块对每个值运行，但是只收集最后一个值：</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">Collecting <span class="number">1</span></span><br><span class="line">Collecting <span class="number">2</span></span><br><span class="line">Collecting <span class="number">3</span></span><br><span class="line">Done <span class="number">3</span></span><br><span class="line">Collected <span class="keyword">in</span> <span class="number">691</span> ms</span><br></pre></td></tr></table></figure>



<h2 id="Zip方法"><a href="#Zip方法" class="headerlink" title="Zip方法"></a>Zip方法</h2><figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> nums = (<span class="number">1</span>..<span class="number">3</span>).asFlow() <span class="comment">// 数字 1..3</span></span><br><span class="line"><span class="keyword">val</span> strs = flowOf(<span class="string">"one"</span>, <span class="string">"two"</span>, <span class="string">"three"</span>) <span class="comment">// 字符串</span></span><br><span class="line">nums.zip(strs) &#123; a, b -&gt; <span class="string">"<span class="variable">$a</span> -&gt; <span class="variable">$b</span>"</span> &#125; <span class="comment">// 组合单个字符串</span></span><br><span class="line">    .collect &#123; println(it) &#125; <span class="comment">// 收集并打印</span></span><br></pre></td></tr></table></figure>

<figure class="highlight basic"><table><tr><td class="code"><pre><span class="line"><span class="symbol">1 </span>-&gt; one</span><br><span class="line"><span class="symbol">2 </span>-&gt; two</span><br><span class="line"><span class="symbol">3 </span>-&gt; three</span><br></pre></td></tr></table></figure>



<h2 id="Combine"><a href="#Combine" class="headerlink" title="Combine"></a>Combine</h2><p>当流表示一个变量或操作的最新值时，可能需要执行计算，这依赖于相应流的最新值，并且每当上游流产生值的时候都需要重新计算。</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> nums = (<span class="number">1</span>..<span class="number">3</span>).asFlow().onEach &#123; delay(<span class="number">300</span>) &#125; <span class="comment">// 发射数字 1..3，间隔 300 毫秒</span></span><br><span class="line"><span class="keyword">val</span> strs = flowOf(<span class="string">"one"</span>, <span class="string">"two"</span>, <span class="string">"three"</span>).onEach &#123; delay(<span class="number">400</span>) &#125; <span class="comment">// 每 400 毫秒发射一次字符串</span></span><br><span class="line"><span class="keyword">val</span> startTime = System.currentTimeMillis() <span class="comment">// 记录开始的时间</span></span><br><span class="line">nums.zip(strs) &#123; a, b -&gt; <span class="string">"<span class="variable">$a</span> -&gt; <span class="variable">$b</span>"</span> &#125; <span class="comment">// 使用“zip”组合单个字符串</span></span><br><span class="line">    .collect &#123; value -&gt; <span class="comment">// 收集并打印</span></span><br><span class="line">        println(<span class="string">"<span class="variable">$value</span> at <span class="subst">$&#123;System.currentTimeMillis() - startTime&#125;</span> ms from start"</span>) </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight basic"><table><tr><td class="code"><pre><span class="line"><span class="symbol">1 </span>-&gt; one at <span class="number">425</span> ms from start</span><br><span class="line"><span class="symbol">2 </span>-&gt; two at <span class="number">825</span> ms from start</span><br><span class="line"><span class="symbol">3 </span>-&gt; three at <span class="number">1227</span> ms from start</span><br></pre></td></tr></table></figure>



<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> nums = (<span class="number">1</span>..<span class="number">3</span>).asFlow().onEach &#123; delay(<span class="number">300</span>) &#125; <span class="comment">// 发射数字 1..3，间隔 300 毫秒</span></span><br><span class="line"><span class="keyword">val</span> strs = flowOf(<span class="string">"one"</span>, <span class="string">"two"</span>, <span class="string">"three"</span>).onEach &#123; delay(<span class="number">400</span>) &#125; <span class="comment">// 每 400 毫秒发射一次字符串</span></span><br><span class="line"><span class="keyword">val</span> startTime = System.currentTimeMillis() <span class="comment">// 记录开始的时间</span></span><br><span class="line">nums.combine(strs) &#123; a, b -&gt; <span class="string">"<span class="variable">$a</span> -&gt; <span class="variable">$b</span>"</span> &#125; <span class="comment">// 使用“combine”组合单个字符串</span></span><br><span class="line">    .collect &#123; value -&gt; <span class="comment">// 收集并打印</span></span><br><span class="line">        println(<span class="string">"<span class="variable">$value</span> at <span class="subst">$&#123;System.currentTimeMillis() - startTime&#125;</span> ms from start"</span>) </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight basic"><table><tr><td class="code"><pre><span class="line"><span class="symbol">1 </span>-&gt; one at <span class="number">443</span> ms from start</span><br><span class="line"><span class="symbol">2 </span>-&gt; one at <span class="number">644</span> ms from start</span><br><span class="line"><span class="symbol">2 </span>-&gt; two at <span class="number">845</span> ms from start</span><br><span class="line"><span class="symbol">3 </span>-&gt; two at <span class="number">944</span> ms from start</span><br><span class="line"><span class="symbol">3 </span>-&gt; three at <span class="number">1245</span> ms from start</span><br></pre></td></tr></table></figure>



<h2 id="flatMapConcat"><a href="#flatMapConcat" class="headerlink" title="flatMapConcat"></a>flatMapConcat</h2><p>连接模式由 flatMapConcat 与 flattenConcat 操作符实现。</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">requestFlow</span><span class="params">(i: <span class="type">Int</span>)</span></span>: Flow&lt;String&gt; = flow &#123;</span><br><span class="line">    emit(<span class="string">"<span class="variable">$i</span>: First"</span>) </span><br><span class="line">    delay(<span class="number">500</span>) <span class="comment">// 等待 500 毫秒</span></span><br><span class="line">    emit(<span class="string">"<span class="variable">$i</span>: Second"</span>)    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123; </span><br><span class="line">    <span class="keyword">val</span> startTime = System.currentTimeMillis() <span class="comment">// 记录开始时间</span></span><br><span class="line">    (<span class="number">1</span>..<span class="number">3</span>).asFlow().onEach &#123; delay(<span class="number">100</span>) &#125; <span class="comment">// 每 100 毫秒发射一个数字 </span></span><br><span class="line">        .flatMapConcat &#123; requestFlow(it) &#125;                                                                           </span><br><span class="line">        .collect &#123; value -&gt; <span class="comment">// 收集并打印</span></span><br><span class="line">            println(<span class="string">"<span class="variable">$value</span> at <span class="subst">$&#123;System.currentTimeMillis() - startTime&#125;</span> ms from start"</span>) </span><br><span class="line">        &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>: First at <span class="number">127</span> <span class="keyword">ms</span> <span class="title">from</span> <span class="literal">start</span></span><br><span class="line"><span class="number">1</span>: Second at <span class="number">628</span> <span class="keyword">ms</span> <span class="title">from</span> <span class="literal">start</span></span><br><span class="line"><span class="number">2</span>: First at <span class="number">729</span> <span class="keyword">ms</span> <span class="title">from</span> <span class="literal">start</span></span><br><span class="line"><span class="number">2</span>: Second at <span class="number">1229</span> <span class="keyword">ms</span> <span class="title">from</span> <span class="literal">start</span></span><br><span class="line"><span class="number">3</span>: First at <span class="number">1329</span> <span class="keyword">ms</span> <span class="title">from</span> <span class="literal">start</span></span><br><span class="line"><span class="number">3</span>: Second at <span class="number">1830</span> <span class="keyword">ms</span> <span class="title">from</span> <span class="literal">start</span></span><br></pre></td></tr></table></figure>



<h2 id="flatMapMerge"><a href="#flatMapMerge" class="headerlink" title="flatMapMerge"></a>flatMapMerge</h2><p>另一种展平模式是并发收集所有传入的流，并将它们的值合并到一个单独的流，以便尽快的发射值。 它由 flatMapMerge 与 flattenMerge 操作符实现。</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">requestFlow</span><span class="params">(i: <span class="type">Int</span>)</span></span>: Flow&lt;String&gt; = flow &#123;</span><br><span class="line">    emit(<span class="string">"<span class="variable">$i</span>: First"</span>) </span><br><span class="line">    delay(<span class="number">500</span>) <span class="comment">// 等待 500 毫秒</span></span><br><span class="line">    emit(<span class="string">"<span class="variable">$i</span>: Second"</span>)    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123; </span><br><span class="line">    <span class="keyword">val</span> startTime = System.currentTimeMillis() <span class="comment">// 记录开始时间</span></span><br><span class="line">    (<span class="number">1</span>..<span class="number">3</span>).asFlow().onEach &#123; delay(<span class="number">100</span>) &#125; <span class="comment">// 每 100 毫秒发射一个数字 </span></span><br><span class="line">        .flatMapMerge &#123; requestFlow(it) &#125;                                                                           </span><br><span class="line">        .collect &#123; value -&gt; <span class="comment">// 收集并打印</span></span><br><span class="line">            println(<span class="string">"<span class="variable">$value</span> at <span class="subst">$&#123;System.currentTimeMillis() - startTime&#125;</span> ms from start"</span>) </span><br><span class="line">        &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>: First at <span class="number">136</span> <span class="keyword">ms</span> <span class="title">from</span> <span class="literal">start</span></span><br><span class="line"><span class="number">2</span>: First at <span class="number">231</span> <span class="keyword">ms</span> <span class="title">from</span> <span class="literal">start</span></span><br><span class="line"><span class="number">3</span>: First at <span class="number">333</span> <span class="keyword">ms</span> <span class="title">from</span> <span class="literal">start</span></span><br><span class="line"><span class="number">1</span>: Second at <span class="number">639</span> <span class="keyword">ms</span> <span class="title">from</span> <span class="literal">start</span></span><br><span class="line"><span class="number">2</span>: Second at <span class="number">732</span> <span class="keyword">ms</span> <span class="title">from</span> <span class="literal">start</span></span><br><span class="line"><span class="number">3</span>: Second at <span class="number">833</span> <span class="keyword">ms</span> <span class="title">from</span> <span class="literal">start</span></span><br></pre></td></tr></table></figure>



<h2 id="flatMapLatest"><a href="#flatMapLatest" class="headerlink" title="flatMapLatest"></a>flatMapLatest</h2><figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">requestFlow</span><span class="params">(i: <span class="type">Int</span>)</span></span>: Flow&lt;String&gt; = flow &#123;</span><br><span class="line">    emit(<span class="string">"<span class="variable">$i</span>: First"</span>) </span><br><span class="line">    delay(<span class="number">500</span>) <span class="comment">// 等待 500 毫秒</span></span><br><span class="line">    emit(<span class="string">"<span class="variable">$i</span>: Second"</span>)    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> = runBlocking&lt;<span class="built_in">Unit</span>&gt; &#123; </span><br><span class="line">    <span class="keyword">val</span> startTime = System.currentTimeMillis() <span class="comment">// 记录开始时间</span></span><br><span class="line">    (<span class="number">1</span>..<span class="number">3</span>).asFlow().onEach &#123; delay(<span class="number">100</span>) &#125; <span class="comment">// 每 100 毫秒发射一个数字 </span></span><br><span class="line">        .flatMapLatest &#123; requestFlow(it) &#125;                                                                           </span><br><span class="line">        .collect &#123; value -&gt; <span class="comment">// 收集并打印</span></span><br><span class="line">            println(<span class="string">"<span class="variable">$value</span> at <span class="subst">$&#123;System.currentTimeMillis() - startTime&#125;</span> ms from start"</span>) </span><br><span class="line">        &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>: First at <span class="number">142</span> ms <span class="keyword">from</span> start</span><br><span class="line"><span class="number">2</span>: First at <span class="number">322</span> ms <span class="keyword">from</span> start</span><br><span class="line"><span class="number">3</span>: First at <span class="number">425</span> ms <span class="keyword">from</span> start</span><br><span class="line"><span class="number">3</span>: Second at <span class="number">931</span> ms <span class="keyword">from</span> start</span><br></pre></td></tr></table></figure></div><div style="text-align:center;color: #555;font-size:16px;margin-top: 35px;line-height: 2;margin-bottom: 35px;">-------------本文已结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div><div class="recommended_posts"><h3>推荐阅读</h3><li><a href="https://xxsu.xyz/article/762aaa36/" target="_blank">异步流使用详解</a></li><li><a href="https://xxsu.xyz/article/c47eb885/" target="_blank">协程详解</a></li><li><a href="https://xxsu.xyz/article/2905e442/" target="_blank">Android中协程的特点</a></li></div><div class="post-copyright"><script type="text/javascript" src="/js/copyright.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copyright.css"><p><span>文章作者：</span>BlueSky</p><p><span>本文链接：</span><a href="/article/76ae8ac8/">https://xxsu.xyz/article/76ae8ac8/</a><span class="copy-path"><i class="fa fa-clipboard" data-clipboard-text="https://xxsu.xyz/article/76ae8ac8/"></i></span></p><p><span>版权声明：</span>本博客所有文章除特别声明外，均采用 CC BY-NC-SA 4.0 CN 许可协议。转载请注明出处！</p></div><br><div id="donate"><link rel="stylesheet" type="text/css" href="/css/donate.css"><script type="text/javascript" src="/js/donate.js" successtext="复制成功!"></script><a class="pos-f tr3" id="github" href="https://github.com/Kaiyuan/donate-page" target="_blank" rel="noopener" arget="_blank" title="Github"></a><div id="DonateText">Donate</div><ul class="list pos-f" id="donateBox"><li id="AliPay" qr="/img/zfb_pay.jpg"></li><li id="WeChat" qr="/img/wx_pay.png"></li></ul><div class="pos-f left-100" id="QRBox"><div id="MainBox"></div></div></div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="https://xxsu.xyz/article/76ae8ac8/" data-id="ckmezpf8q001ko8tvcw2afo28" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAK4AAACuCAAAAACKZ2kyAAABwElEQVR42u3aO3LDMAwFQN//0krrJtIDQHKUzLJyIVNLFRh8+PnE6/pa8yfz3ZoLFxd3zL1u1/cz+fP5e8t74uLiHuRWt7sPSb8ddfIMLi7um7nRpsFhcHFx/we3GrxwcXH/OjcpfpLiJC+HttdquLi4u3oXUVCb/97S38XFxW1xr8HK051V78XFxT3DrQadXnMkR0elES4u7mZuPlKtpjv3AataDkXnw8XF3cCdjFJ64Sn5HNFkBhcXdwP3PrHIBx7zS1oPgRUXF/cId56y5GGxFzqbvVtcXNwBNw9keSKS/6saRnFxcc9wq9cv8kZqfhmrPILFxcXdzJ2nI3kDtEp8qNVwcXG3cZNkpVp9VLmjWg0XF3cD9z5Zya9c9AYn5UELLi7uEW4vycgDXO9zPCRPuLi4m7nzpueksVJOd3BxcY9we6lGHqqqbZToMgcuLu5m7lVcvXZJ9TJHc+aDi4u7iJuvVcPXvD06QuPi4o651VZFQpk0UHBxcd/D7QWaalO1V/zg4uK+mVstgZLjlYsfXFzcl3EnhU0e8kajVlxc3KXcefEz78REO+Pi4h7h5hv1Gh95W2TZQAUXF7fP/QHZFL5VwBxFEwAAAABJRU5ErkJggg==">分享</a><div class="tags"><a href="/tags/%E5%8D%8F%E7%A8%8B/"><i class="fa fa-tag"></i>协程</a><a href="/tags/Flow/"><i class="fa fa-tag"></i>Flow</a></div><div class="post-nav"><a class="pre" href="/article/1062d183/">二叉树非递归遍历</a><a class="next" href="/article/22df6896/">并发工具类的使用</a></div><script>daovoice('init', {app_id: "225e0df7"});daovoice('update');</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar-toc"><div class="stoc-article" id="sidebar-stoc"><strong class="stoc-title"><i class="fa fa-blind"> Contents </i></strong><div class="toc-nav" id="stoc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#flowOn-操作符"><span class="toc-number">1.</span> <span class="toc-text">flowOn 操作符</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#缓冲"><span class="toc-number">2.</span> <span class="toc-text">缓冲</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#合并"><span class="toc-number">3.</span> <span class="toc-text">合并</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#处理最新值"><span class="toc-number">4.</span> <span class="toc-text">处理最新值</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Zip方法"><span class="toc-number">5.</span> <span class="toc-text">Zip方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Combine"><span class="toc-number">6.</span> <span class="toc-text">Combine</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#flatMapConcat"><span class="toc-number">7.</span> <span class="toc-text">flatMapConcat</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#flatMapMerge"><span class="toc-number">8.</span> <span class="toc-text">flatMapMerge</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#flatMapLatest"><span class="toc-number">9.</span> <span class="toc-text">flatMapLatest</span></a></li></ol></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">BlueSky's Blog.</a> Powered by<a rel="nofollow" target="_blank"> Hexo.</a><a rel="nofollow" target="_blank"> Theme</a> by<a rel="nofollow" target="_blank"> Cho.</a></div></div></div><script type="text/javascript" src="/js/fixed_toc.js?v=0.0.0" async></script><div class="back-to-top cd-top faa-float animated cd-is-visible" style="top: -999px;"></div><link rel="stylesheet" type="text/css" href="/css/scroll_img.css?v=0.0.0"><script type="text/javascript" src="/js/scroll_img.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><link rel="stylesheet" type="text/css" href="/css/search.css?v=0.0.0"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/love.js"></script><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>